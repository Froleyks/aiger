#!/bin/sh

date=`./maxdate`
version="`sed -e '/AIGER_VERSION/!d' -e 's,^[^"]*",,' -e 's,".*,,g' aiger.h`"

if [ ! X"$date" = X"$version" ]
then
  touch aiger.h
  date=`./maxdate`
  echo "*** warning: fixing version in aiger.h since (version != date)"
  (
  echo '/AIGER_VERSION/'
  echo d
  echo i
  echo "#define AIGER_VERSION \"$date\""
  echo .
  echo w
  echo q
  ) | ed aiger.h 1>/dev/null 2>/dev/null
fi

cvs ci -m 'release $date'
cvs tag -F rel-$date

doc="README FORMAT LICENSE"
impl="`ls *.c *.h|grep -v test`"
examples="`cd examples; ls *.c *.aag makefile|sed -e 's,^,examples/,'`"

files="$doc $impl $examples"

base="aiger-$date"
dir="/tmp/$base"
if [ -d $dir ] 
then 
  rm -rf $dir || exit 1
fi

mkdir $dir || exit 1
mkdir $dir/examples || exit 1

sed -e '/^include test.mk/d' makefile > $dir/makefile

for f in $files
do
  cp $f $dir/$f
  echo $date > $dir/VERSION
done

make || exit 1

cd $dir/examples
for i in *.aag
do
  b=`basename .aag`
  aigtoaig $b.aag $b.aig
done

cd /tmp
if [ -d $HOME/export ]
then
  zip="$HOME/export/${base}.zip"
else
  zip="/tmp/${base}.zip"
fi
rm -f $zip
zip -q -r $zip $base || exit 1
echo $zip
